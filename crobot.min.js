!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CrobotTag={})}(this,function(e){"use strict";function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function n(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function r(e){return function(){var t=this,r=arguments;return new Promise(function(i,o){var a=e.apply(t,r);function s(e){n(a,i,o,s,c,"next",e)}function c(e){n(a,i,o,s,c,"throw",e)}s(void 0)})}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,f(r.key),r)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t,n){return(t=f(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach(function(t){a(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function u(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function o(n,r,i,o){var c=r&&r.prototype instanceof s?r:s,u=Object.create(c.prototype);return l(u,"_invoke",function(n,r,i){var o,s,c,u=0,l=i||[],h=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return o=t,s=0,c=e,d.n=n,a}};function f(n,r){for(s=n,c=r,t=0;!h&&u&&!i&&t<l.length;t++){var i,o=l[t],f=d.p,g=o[2];n>3?(i=g===r)&&(c=o[(s=o[4])?5:(s=3,3)],o[4]=o[5]=e):o[0]<=f&&((i=n<2&&f<o[1])?(s=0,d.v=r,d.n=o[1]):f<g&&(i=n<3||o[0]>r||r>g)&&(o[4]=n,o[5]=r,d.n=g,s=0))}if(i||n>1)return a;throw h=!0,r}return function(i,l,g){if(u>1)throw TypeError("Generator is already running");for(h&&1===l&&f(l,g),s=l,c=g;(t=s<2?e:c)||!h;){o||(s?s<3?(s>1&&(d.n=-1),f(s,c)):d.n=c:d.v=c);try{if(u=2,o){if(s||(i="next"),t=o[i]){if(!(t=t.call(o,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,s<2&&(s=0)}else 1===s&&(t=o.return)&&t.call(o),s<2&&(c=TypeError("The iterator does not provide a '"+i+"' method"),s=1);o=e}else if((t=(h=d.n<0)?c:n.call(r,d))!==a)break}catch(t){o=e,s=1,c=t}finally{u=1}}return{value:t,done:h}}}(n,i,o),!0),u}var a={};function s(){}function c(){}function h(){}t=Object.getPrototypeOf;var d=[][r]?t(t([][r]())):(l(t={},r,function(){return this}),t),f=h.prototype=s.prototype=Object.create(d);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,l(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return c.prototype=h,l(f,"constructor",h),l(h,"constructor",c),c.displayName="GeneratorFunction",l(h,i,"GeneratorFunction"),l(f),l(f,i,"Generator"),l(f,r,function(){return this}),l(f,"toString",function(){return"[object Generator]"}),(u=function(){return{w:o,m:g}})()}function l(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}l=function(e,t,n,r){function o(t,n){l(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},l(e,t,n,r)}function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o,a,s=[],c=!0,u=!1;try{if(o=(n=n.call(e)).next,0===t);else for(;!(c=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){u=!0,i=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw i}}return s}}(e,t)||v(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||v(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function g(e){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g(e)}function v(e,n){if(e){if("string"==typeof e)return t(e,n);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}}var m=function(){return o(function e(t){i(this,e),this.config=t,this.events=[],this.maxEvents=1e3},[{key:"addEvent",value:function(e){e.timestamp||(e.timestamp=Date.now()),this.events.push(e),this.events.length>this.maxEvents&&(this.events=this.events.slice(-this.maxEvents)),this.config.debug&&console.log("Event collected:",e)}},{key:"getEvents",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=d(this.events);return e.event&&(t=t.filter(function(t){return t.event===e.event})),e.since&&(t=t.filter(function(t){return t.timestamp>=e.since})),e.until&&(t=t.filter(function(t){return t.timestamp<=e.until})),t}},{key:"getEventCount",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return e?this.events.filter(function(t){return t.event===e}).length:this.events.length}},{key:"clearEvents",value:function(){this.events=[]}},{key:"getLastEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e?this.events.filter(function(t){return t.event===e}):this.events;return t.length>0?t[t.length-1]:null}}])}();function p(){return"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function y(){return"user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function k(){return Date.now()}function w(e){if(0===e)return"0 Bytes";var t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function b(e,t){if(!e||"object"!==g(e))return e;var n=c({},e);return["email","phone","ssn","credit_card","password","first_name","last_name","address","zip_code"].forEach(function(e){n[e]&&delete n[e]}),t.privacy.anonymizeIp&&n.ip&&(n.ip=function(e){if(!e)return e;if(e.includes(".")){var t=e.split(".");if(4===t.length)return t.slice(0,3).join(".")+".0"}if(e.includes(":")){var n=e.split(":");if(n.length>=4)return n.slice(0,-4).join(":")+"::"}return e}(n.ip)),n.url&&(n.url=function(e){try{var t=new URL(e);return["token","key","secret","password","auth","session","sid","csrf","api_key"].forEach(function(e){t.searchParams.delete(e)}),t.toString()}catch(t){return e}}(n.url)),Object.keys(n).forEach(function(e){"string"==typeof n[e]&&n[e].length>1e3&&(n[e]=n[e].substring(0,1e3)+"...")}),n}function _(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"analytics";if(window.gtag&&window.gtag.getConsent)try{var t=window.gtag.getConsent();return t&&t[e]}catch(e){}if(window.OneTrust&&window.OneTrust.getConsent)try{return window.OneTrust.getConsent(e)}catch(e){}if(window.Cookiebot&&window.Cookiebot.consent)try{return window.Cookiebot.consent[e]}catch(e){}return!0}function T(e){var t={analytics:!0,marketing:!0,functional:!0,necessary:!0};return e.privacy.consentRequired&&(t.analytics=_("analytics"),t.marketing=_("marketing"),t.functional=_("functional"),t.necessary=_("necessary")),!e.privacy.respectDoNotTrack||"1"!==navigator.doNotTrack&&"yes"!==navigator.doNotTrack&&"1"!==navigator.msDoNotTrack&&"1"!==window.doNotTrack||(t.analytics=!1,t.marketing=!1),t}function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"analytics",n=T(e);return n[t]||n.necessary}var x=function(){return o(function e(t,n){var r=this;i(this,e),a(this,"handleClick",function(e){var t=e.target,n={element_tag:t.tagName.toLowerCase(),element_id:t.id||null,element_class:t.className||null,element_text:r.getElementText(t),element_href:t.href||null,click_x:e.clientX,click_y:e.clientY,page_x:e.pageX,page_y:e.pageY};r.track("click",n)}),a(this,"handleFormSubmit",function(e){var t=e.target,n={form_id:t.id||null,form_class:t.className||null,form_action:t.action||null,form_method:t.method||"get",field_count:t.elements.length};r.track("form_submit",n)}),a(this,"handleVisibilityChange",function(){if(document.hidden){var e=k()-r.pageStartTime;r.track("page_hidden",{time_on_page:e})}else r.pageStartTime=k(),r.track("page_visible")}),this.config=t,this.dataSender=n,this.eventCollector=new m(t),this.sessionId=this.getOrCreateSessionId(),this.userId=this.getOrCreateUserId(),this.sessionStartTime=k(),this.pageStartTime=k(),this.isTracking=!1},[{key:"start",value:function(){this.isTracking||(this.isTracking=!0,this.trackPageView(),this.config.tracking.pageViews&&this.setupPageViewTracking(),this.config.tracking.clicks&&this.setupClickTracking(),this.config.tracking.scroll&&this.setupScrollTracking(),this.config.tracking.formSubmissions&&this.setupFormTracking(),this.config.tracking.timeOnPage&&this.setupTimeTracking(),this.config.tracking.performance&&this.setupPerformanceTracking())}},{key:"stop",value:function(){this.isTracking&&(this.isTracking=!1,this.track("session_end",{session_duration:k()-this.sessionStartTime}),this.removeEventListeners())}},{key:"track",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.isTracking){this.updateSessionActivity();var n={event:e,properties:b(t,this.config),timestamp:k(),session_id:this.sessionId,user_id:this.userId,page_url:window.location.href,page_title:document.title,user_agent:navigator.userAgent,referrer:document.referrer};this.eventCollector.addEvent(n),this.dataSender.send(n),this.config.debug&&console.log("Crobot Tag: Event tracked",n)}}},{key:"identify",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.userId=e,this.storeUserId(e),this.track("user_identified",{user_id:e,traits:b(t,this.config)})}},{key:"page",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.track("page_view",c({page_name:e},t))}},{key:"trackPageView",value:function(){var e={page_url:window.location.href,page_title:document.title,page_path:window.location.pathname,page_search:window.location.search,page_hash:window.location.hash,referrer:document.referrer,viewport_width:window.innerWidth,viewport_height:window.innerHeight,screen_width:screen.width,screen_height:screen.height,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language};this.track("page_view",e)}},{key:"setupPageViewTracking",value:function(){var e=this,t=window.location.href,n=function(){window.location.href!==t&&(t=window.location.href,e.pageStartTime=k(),e.trackPageView())};setInterval(n,1e3),window.addEventListener("popstate",n);var r=history.pushState,i=history.replaceState;history.pushState=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r.apply(history,t),setTimeout(n,0)},history.replaceState=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];i.apply(history,t),setTimeout(n,0)}}},{key:"setupClickTracking",value:function(){document.addEventListener("click",this.handleClick,!0)}},{key:"setupScrollTracking",value:function(){var e,t=this,n=0;window.addEventListener("scroll",function(){var r=Math.round((window.scrollY+window.innerHeight)/document.documentElement.scrollHeight*100);r>n&&(n=r,r>=25&&r<50&&n<50?t.track("scroll",{depth:25}):r>=50&&r<75&&n<75?t.track("scroll",{depth:50}):r>=75&&r<90&&n<90?t.track("scroll",{depth:75}):r>=90&&t.track("scroll",{depth:90})),clearTimeout(e),e=setTimeout(function(){t.track("scroll",{depth:r})},100)},{passive:!0})}},{key:"setupFormTracking",value:function(){document.addEventListener("submit",this.handleFormSubmit,!0)}},{key:"setupTimeTracking",value:function(){var e=this;window.addEventListener("beforeunload",function(){var t=k()-e.pageStartTime;e.track("time_on_page",{duration:t})}),document.addEventListener("visibilitychange",this.handleVisibilityChange)}},{key:"setupPerformanceTracking",value:function(){var e=this;window.performance&&window.performance.timing&&window.addEventListener("load",function(){setTimeout(function(){var t=window.performance.timing,n=window.performance.navigation,r={load_time:t.loadEventEnd-t.navigationStart,dom_ready:t.domContentLoadedEventEnd-t.navigationStart,first_byte:t.responseStart-t.navigationStart,navigation_type:n.type,redirect_count:n.redirectCount};window.performance.getEntriesByType&&window.performance.getEntriesByType("paint").forEach(function(e){"first-contentful-paint"===e.name&&(r.first_contentful_paint=e.startTime)});e.track("performance",r)},0)})}},{key:"getElementText",value:function(e){return e.textContent?e.textContent.trim().substring(0,100):null}},{key:"getOrCreateUserId",value:function(){var e=localStorage.getItem("crobot_user_id");if(e)return e;var t=y();return this.storeUserId(t),t}},{key:"getOrCreateSessionId",value:function(){var e=localStorage.getItem("crobot_session_id"),t=localStorage.getItem("crobot_session_timestamp"),n=this.config.tracking.sessionTimeout||18e5;if(e&&t&&Date.now()-parseInt(t)<n)return e;var r=p();return this.storeSessionId(r),r}},{key:"storeUserId",value:function(e){try{localStorage.setItem("crobot_user_id",e)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not store user ID",e)}}},{key:"storeSessionId",value:function(e){try{var t=Date.now().toString();localStorage.setItem("crobot_session_id",e),localStorage.setItem("crobot_session_timestamp",t),this.config.debug&&console.log("Crobot Tag: Stored new session ID",e)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not store session ID",e)}}},{key:"updateSessionActivity",value:function(){try{var e=Date.now().toString();localStorage.setItem("crobot_session_timestamp",e)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not update session activity",e)}}},{key:"removeEventListeners",value:function(){document.removeEventListener("click",this.handleClick,!0),document.removeEventListener("submit",this.handleFormSubmit,!0),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}}])}(),E=function(){return o(function e(t){i(this,e),this.config=t,this.executionTimeout=t.experiments.executionTimeout||5e3,this.activeExecutions=new Set},[{key:"execute",value:function(e,t){var n=this,r=this.generateExecutionId();this.activeExecutions.add(r);try{var i=this.createSandbox(t),o=setTimeout(function(){throw n.activeExecutions.delete(r),new Error("Experiment execution timeout")},this.executionTimeout),a=this.executeInSandbox(e,i);return clearTimeout(o),this.activeExecutions.delete(r),a}catch(e){throw this.activeExecutions.delete(r),e}}},{key:"createSandbox",value:function(e){return{experimentId:e.experimentId,variantId:e.variantId,userId:e.userId,experiment:e.experiment,variant:e.variant,document:this.createSafeDocument(),window:this.createSafeWindow(),console:this.createSafeConsole(),localStorage:null,sessionStorage:null,fetch:null,XMLHttpRequest:null,eval:null,Function:null}}},{key:"executeInSandbox",value:function(e,t){return new Function("sandbox","\n      with (sandbox) {\n        ".concat(e,"\n      }\n      "))(t)}},{key:"createSafeDocument",value:function(){return{querySelector:function(e){try{return document.querySelector(e)}catch(e){return null}},querySelectorAll:function(e){try{return Array.from(document.querySelectorAll(e))}catch(e){return[]}},getElementById:function(e){try{return document.getElementById(e)}catch(e){return null}},getElementsByClassName:function(e){try{return Array.from(document.getElementsByClassName(e))}catch(e){return[]}},getElementsByTagName:function(e){try{return Array.from(document.getElementsByTagName(e))}catch(e){return[]}},createElement:function(e){try{return document.createElement(e)}catch(e){return null}},addEventListener:function(e,t){try{document.addEventListener(e,t)}catch(e){}},removeEventListener:function(e,t){try{document.removeEventListener(e,t)}catch(e){}}}}},{key:"createSafeWindow",value:function(){return{location:{href:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash},innerWidth:window.innerWidth,innerHeight:window.innerHeight,scrollX:window.scrollX,scrollY:window.scrollY,setTimeout:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){try{return setTimeout(e,t)}catch(e){return null}}),clearTimeout:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){try{clearTimeout(e)}catch(e){}}),setInterval:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){try{return setInterval(e,t)}catch(e){return null}}),clearInterval:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){try{clearInterval(e)}catch(e){}})}}},{key:"createSafeConsole",value:function(){var e=this;return{log:function(){if(e.config.debug){for(var t,n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];(t=console).log.apply(t,["[Experiment]"].concat(r))}},warn:function(){if(e.config.debug){for(var t,n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];(t=console).warn.apply(t,["[Experiment]"].concat(r))}},error:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).error.apply(e,["[Experiment]"].concat(n))}}}},{key:"generateExecutionId",value:function(){return"exec_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}},{key:"destroy",value:function(){this.activeExecutions.clear()}}])}(),C=function(){return o(function e(t){i(this,e),this.config=t},[{key:"isUserEligible",value:function(e){var t=this;return!e||(!e.rules||!Array.isArray(e.rules)||e.rules.every(function(e){return t.evaluateRule(e)}))}},{key:"evaluateRule",value:function(e){switch(e.type){case"url":return this.evaluateUrlRule(e);case"user_property":return this.evaluateUserPropertyRule(e);case"device":return this.evaluateDeviceRule(e);case"time":return this.evaluateTimeRule(e);case"random":return this.evaluateRandomRule(e);case"custom":return this.evaluateCustomRule(e);default:return!0}}},{key:"evaluateUrlRule",value:function(e){var t=window.location.href,n=window.location.pathname;switch(e.operator){case"equals":return t===e.value;case"contains":return t.includes(e.value);case"starts_with":return t.startsWith(e.value);case"ends_with":return t.endsWith(e.value);case"regex":try{return new RegExp(e.value).test(t)}catch(e){return!1}case"path_equals":return n===e.value;case"path_contains":return n.includes(e.value);default:return!0}}},{key:"evaluateUserPropertyRule",value:function(e){var t=this.getUserProperty(e.property);switch(e.operator){case"equals":return t===e.value;case"not_equals":return t!==e.value;case"contains":return String(t).includes(e.value);case"greater_than":return Number(t)>Number(e.value);case"less_than":return Number(t)<Number(e.value);case"in":return Array.isArray(e.value)&&e.value.includes(t);case"not_in":return Array.isArray(e.value)&&!e.value.includes(t);default:return!0}}},{key:"evaluateDeviceRule",value:function(e){var t=navigator.userAgent.toLowerCase();switch(e.property){case"browser":return this.checkBrowser(t,e.value);case"os":return this.checkOS(t,e.value);case"device_type":return this.checkDeviceType(t,e.value);case"screen_width":return this.checkScreenWidth(e);case"screen_height":return this.checkScreenHeight(e);default:return!0}}},{key:"evaluateTimeRule",value:function(e){var t=new Date;switch(e.property){case"hour":return this.checkHour(t,e);case"day_of_week":return this.checkDayOfWeek(t,e);case"date_range":return this.checkDateRange(t,e);default:return!0}}},{key:"evaluateRandomRule",value:function(e){var t=e.percentage||100;return 100*Math.random()<t}},{key:"evaluateCustomRule",value:function(e){try{return new Function("context",e.code)(this.getCustomContext())}catch(e){return console.error("Crobot Tag: Custom rule evaluation failed",e),!1}}},{key:"getUserProperty",value:function(e){return this.getUserData()[e]}},{key:"getUserData",value:function(){var e={};try{var t=localStorage.getItem("crobot_user_data");t&&Object.assign(e,JSON.parse(t))}catch(e){}return e}},{key:"checkBrowser",value:function(e,t){var n={chrome:/chrome/i,firefox:/firefox/i,safari:/safari/i,edge:/edge/i,ie:/msie|trident/i};return!!n[t]&&n[t].test(e)}},{key:"checkOS",value:function(e,t){var n={windows:/windows/i,mac:/macintosh|mac os x/i,linux:/linux/i,android:/android/i,ios:/iphone|ipad|ipod/i};return!!n[t]&&n[t].test(e)}},{key:"checkDeviceType",value:function(e,t){switch(t){case"mobile":return/mobile|android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e);case"tablet":return/tablet|ipad|android(?!.*mobile)/i.test(e);case"desktop":return!/mobile|tablet|android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e);default:return!0}}},{key:"checkScreenWidth",value:function(e){var t=screen.width;switch(e.operator){case"equals":return t===e.value;case"greater_than":return t>e.value;case"less_than":return t<e.value;case"between":return t>=e.value[0]&&t<=e.value[1];default:return!0}}},{key:"checkScreenHeight",value:function(e){var t=screen.height;switch(e.operator){case"equals":return t===e.value;case"greater_than":return t>e.value;case"less_than":return t<e.value;case"between":return t>=e.value[0]&&t<=e.value[1];default:return!0}}},{key:"checkHour",value:function(e,t){var n=e.getHours();switch(t.operator){case"equals":return n===t.value;case"between":return n>=t.value[0]&&n<=t.value[1];default:return!0}}},{key:"checkDayOfWeek",value:function(e,t){var n=e.getDay();switch(t.operator){case"equals":return n===t.value;case"in":return Array.isArray(t.value)&&t.value.includes(n);default:return!0}}},{key:"checkDateRange",value:function(e,t){var n=new Date(t.value[0]),r=new Date(t.value[1]);return e>=n&&e<=r}},{key:"getCustomContext",value:function(){return{url:window.location.href,pathname:window.location.pathname,userAgent:navigator.userAgent,screenWidth:screen.width,screenHeight:screen.height,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight,timestamp:Date.now(),userData:this.getUserData()}}}])}(),I=function(){return o(function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i(this,e),this.config=t,this.dataSender=n,this.sessionId=r,this.goals=new Map,this.activeGoals=new Map,this.completedGoals=new Set,this.goalListeners=new Map,this.isInitialized=!1},[{key:"registerGoals",value:function(e,t){var n=this;Array.isArray(t)&&0!==t.length&&(this.goals.set(e,t),t.forEach(function(t){n.validateGoal(t)?n.setupGoalTracking(e,t):console.warn("Crobot Tag: Invalid goal configuration",t)}),this.config.debug&&console.log("Crobot Tag: Registered ".concat(t.length," goals for experiment ").concat(e)))}},{key:"validateGoal",value:function(e){if(!e.id||!e.name||!e.type)return!1;return["element_visible","element_clicked","element_hovered","element_focused","form_submitted","form_field_filled","page_viewed","url_changed","url_visited","time_on_page","time_on_site","scroll_depth","element_scrolled_into_view","custom_event","sequence_completed"].includes(e.type)?!(this.requiresSelector(e.type)&&!e.selector)||(console.warn("Crobot Tag: Goal ".concat(e.id," requires a selector")),!1):(console.warn("Crobot Tag: Invalid goal type: ".concat(e.type)),!1)}},{key:"requiresSelector",value:function(e){return["element_visible","element_clicked","element_hovered","element_focused","form_submitted","form_field_filled","element_scrolled_into_view"].includes(e)}},{key:"setupGoalTracking",value:function(e,t){var n="".concat(e,"_").concat(t.id);switch(this.activeGoals.set(n,c(c({},t),{},{experimentId:e})),t.type){case"element_visible":this.setupElementVisibleTracking(n,t);break;case"element_clicked":this.setupElementClickedTracking(n,t);break;case"element_hovered":this.setupElementHoveredTracking(n,t);break;case"element_focused":this.setupElementFocusedTracking(n,t);break;case"form_submitted":this.setupFormSubmittedTracking(n,t);break;case"form_field_filled":this.setupFormFieldFilledTracking(n,t);break;case"page_viewed":this.setupPageViewedTracking(n,t);break;case"url_changed":this.setupUrlChangedTracking(n,t);break;case"url_visited":this.setupUrlVisitedTracking(n,t);break;case"time_on_page":this.setupTimeOnPageTracking(n,t);break;case"time_on_site":this.setupTimeOnSiteTracking(n,t);break;case"scroll_depth":this.setupScrollDepthTracking(n,t);break;case"element_scrolled_into_view":this.setupElementScrolledIntoViewTracking(n,t);break;case"custom_event":this.setupCustomEventTracking(n,t);break;case"sequence_completed":this.setupSequenceCompletedTracking(n,t);break;default:console.warn("Crobot Tag: Unsupported goal type: ".concat(t.type))}}},{key:"setupElementVisibleTracking",value:function(e,t){var n,r=this,i=document.querySelectorAll(t.selector);if(0!==i.length){var o=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&r.handleGoalCompletion(e,t.target)})},{threshold:(null===(n=t.conditions)||void 0===n?void 0:n.threshold)||.5}),a=new MutationObserver(function(t){t.forEach(function(t){if("attributes"===t.type&&"style"===t.attributeName){var n=t.target,i=window.getComputedStyle(n);"none"!==i.display&&"hidden"!==i.visibility&&setTimeout(function(){var t=n.getBoundingClientRect();t.top<window.innerHeight&&t.bottom>0&&r.handleGoalCompletion(e,n)},100)}})});i.forEach(function(e){o.observe(e),a.observe(e,{attributes:!0,attributeFilter:["style","class"]})}),this.goalListeners.set(e,function(){o.disconnect(),a.disconnect()})}else console.warn("Crobot Tag: No elements found for selector: ".concat(t.selector))}},{key:"setupElementClickedTracking",value:function(e,t){var n=this,r=document.querySelectorAll(t.selector);if(0!==r.length){var i=function(t){n.handleGoalCompletion(e,t.target)};r.forEach(function(e){e.addEventListener("click",i)}),this.goalListeners.set(e,function(){r.forEach(function(e){e.removeEventListener("click",i)})})}else console.warn("Crobot Tag: No elements found for selector: ".concat(t.selector))}},{key:"setupElementHoveredTracking",value:function(e,t){var n=this,r=document.querySelectorAll(t.selector);if(0!==r.length){var i=function(t){n.handleGoalCompletion(e,t.target)};r.forEach(function(e){e.addEventListener("mouseenter",i)}),this.goalListeners.set(e,function(){r.forEach(function(e){e.removeEventListener("mouseenter",i)})})}else console.warn("Crobot Tag: No elements found for selector: ".concat(t.selector))}},{key:"setupElementFocusedTracking",value:function(e,t){var n=this,r=document.querySelectorAll(t.selector);if(0!==r.length){var i=function(t){n.handleGoalCompletion(e,t.target)};r.forEach(function(e){e.addEventListener("focus",i)}),this.goalListeners.set(e,function(){r.forEach(function(e){e.removeEventListener("focus",i)})})}else console.warn("Crobot Tag: No elements found for selector: ".concat(t.selector))}},{key:"setupFormSubmittedTracking",value:function(e,t){var n=this,r=document.querySelectorAll(t.selector);if(0!==r.length){var i=function(t){n.handleGoalCompletion(e,t.target)};r.forEach(function(e){e.addEventListener("submit",i)}),this.goalListeners.set(e,function(){r.forEach(function(e){e.removeEventListener("submit",i)})})}else console.warn("Crobot Tag: No forms found for selector: ".concat(t.selector))}},{key:"setupFormFieldFilledTracking",value:function(e,t){var n=this,r=document.querySelectorAll(t.selector);if(0!==r.length){var i=function(t){t.target.value&&""!==t.target.value.trim()&&n.handleGoalCompletion(e,t.target)};r.forEach(function(e){e.addEventListener("input",i),e.addEventListener("change",i)}),this.goalListeners.set(e,function(){r.forEach(function(e){e.removeEventListener("input",i),e.removeEventListener("change",i)})})}else console.warn("Crobot Tag: No form fields found for selector: ".concat(t.selector))}},{key:"setupPageViewedTracking",value:function(e,t){var n=this;this.matchesPageCriteria(t)&&this.handleGoalCompletion(e,document);var r=function(){n.matchesPageCriteria(t)&&n.handleGoalCompletion(e,document)};window.addEventListener("popstate",r),this.goalListeners.set(e,function(){window.removeEventListener("popstate",r)})}},{key:"setupUrlChangedTracking",value:function(e,t){var n=this,r=function(){n.matchesUrlCriteria(t)&&n.handleGoalCompletion(e,document)};window.addEventListener("popstate",r),window.addEventListener("pushstate",r),window.addEventListener("replacestate",r),this.goalListeners.set(e,function(){window.removeEventListener("popstate",r),window.removeEventListener("pushstate",r),window.removeEventListener("replacestate",r)})}},{key:"setupUrlVisitedTracking",value:function(e,t){var n=this;if(this.matchesUrlCriteria(t))this.handleGoalCompletion(e,document);else{var r=function(){n.matchesUrlCriteria(t)&&n.handleGoalCompletion(e,document)};window.addEventListener("popstate",r),window.addEventListener("pushstate",r),window.addEventListener("replacestate",r),this.goalListeners.set(e,function(){window.removeEventListener("popstate",r),window.removeEventListener("pushstate",r),window.removeEventListener("replacestate",r)})}}},{key:"setupTimeOnPageTracking",value:function(e,t){var n,r=this,i=(null===(n=t.conditions)||void 0===n?void 0:n.time_threshold)||3e4,o=setTimeout(function(){r.handleGoalCompletion(e,document)},i);this.goalListeners.set(e,function(){clearTimeout(o)})}},{key:"setupTimeOnSiteTracking",value:function(e,t){var n,r=this,i=(null===(n=t.conditions)||void 0===n?void 0:n.time_threshold)||6e4,o=setTimeout(function(){r.handleGoalCompletion(e,document)},i);this.goalListeners.set(e,function(){clearTimeout(o)})}},{key:"setupScrollDepthTracking",value:function(e,t){var n,r=this,i=(null===(n=t.conditions)||void 0===n?void 0:n.scroll_threshold)||.8,o=0,a=function(){var t=(window.pageYOffset||document.documentElement.scrollTop)/(document.documentElement.scrollHeight-window.innerHeight);t>o&&(o=t),o>=i&&r.handleGoalCompletion(e,document)};window.addEventListener("scroll",a,{passive:!0}),this.goalListeners.set(e,function(){window.removeEventListener("scroll",a)})}},{key:"setupElementScrolledIntoViewTracking",value:function(e,t){var n,r=this,i=document.querySelectorAll(t.selector);if(0!==i.length){var o=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&r.handleGoalCompletion(e,t.target)})},{threshold:(null===(n=t.conditions)||void 0===n?void 0:n.threshold)||.5});i.forEach(function(e){o.observe(e)}),this.goalListeners.set(e,function(){o.disconnect()})}else console.warn("Crobot Tag: No elements found for selector: ".concat(t.selector))}},{key:"setupCustomEventTracking",value:function(e,t){var n,r=this,i=(null===(n=t.conditions)||void 0===n?void 0:n.event_name)||"crobot_goal",o=function(t){r.handleGoalCompletion(e,t.target)};document.addEventListener(i,o),this.goalListeners.set(e,function(){document.removeEventListener(i,o)})}},{key:"setupSequenceCompletedTracking",value:function(e,t){var n,r=(null===(n=t.conditions)||void 0===n?void 0:n.sequence)||[],i=new Map;r.forEach(function(e,t){i.set(t,!1)}),r.forEach(function(e,t){console.log("Crobot Tag: Setting up sequence step ".concat(t,":"),e)}),this.goalListeners.set(e,function(){i.clear()})}},{key:"handleGoalCompletion",value:function(e,t){var n,r,i=this,o=this.activeGoals.get(e);o&&(null!==(n=o.conditions)&&void 0!==n&&n.once_per_session&&this.completedGoals.has(e)||(null!==(r=o.conditions)&&void 0!==r&&r.delay?setTimeout(function(){i.fireGoalEvent(e,t)},o.conditions.delay):this.fireGoalEvent(e,t)))}},{key:"fireGoalEvent",value:function(e,t){var n=this.activeGoals.get(e);if(n){this.completedGoals.add(e),this.updateSessionActivity();var r=this.extractValue(n,t),i=this.extractProperties(n,t),o={experiment_id:n.experimentId,goal_id:n.id,goal_name:n.name,goal_type:n.type,value:r,properties:i,user_id:this.config.userId||"anonymous",session_id:this.getSessionId(),client_id:this.config.clientId||null,page_url:window.location.href,page_title:document.title};this.sendGoalCompletion(o),this.config.debug&&console.log("Crobot Tag: Goal completed",o)}}},{key:"sendGoalCompletion",value:(e=r(u().m(function e(t){var n,r,i,o;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n="".concat(this.config.endpoint,"/goals/complete"),e.n=1,fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify(t)});case 1:if((r=e.v).ok){e.n=2;break}throw new Error("HTTP ".concat(r.status,": ").concat(r.statusText));case 2:this.config.debug&&console.log("Crobot Tag: Goal completion sent successfully",t),e.n=4;break;case 3:e.p=3,o=e.v,console.error("Crobot Tag: Failed to send goal completion:",o),this.dataSender&&(i=c(c({event:"goal_completed"},t),{},{timestamp:k()}),this.dataSender.send(i));case 4:return e.a(2)}},e,this,[[0,3]])})),function(t){return e.apply(this,arguments)})},{key:"extractValue",value:function(e,t){if(!e.value)return null;if("static"===e.value.type)return e.value.value;if("dynamic"===e.value.type&&e.value.selector){var n=document.querySelector(e.value.selector);if(n)return this.extractValueFromElement(n,e.value)}return e.value.fallback||null}},{key:"extractValueFromElement",value:function(e,t){var n,r;switch(t.extractor){case"text":return null===(n=e.textContent)||void 0===n?void 0:n.trim();case"attribute":return e.getAttribute(t.attribute);case"dataset":return e.dataset[t.attribute];case"function":if("function"==typeof t.function)return t.function(e);break;default:return null===(r=e.textContent)||void 0===r?void 0:r.trim()}return null}},{key:"extractProperties",value:function(e,t){var n=this,r={};return e.properties&&Object.entries(e.properties).forEach(function(e){var t=h(e,2),i=t[0],o=t[1],a=document.querySelector(o.selector);a&&(r[i]=n.extractValueFromElement(a,o))}),r}},{key:"matchesPageCriteria",value:function(e){var t;if(null===(t=e.conditions)||void 0===t||!t.page_criteria)return!0;var n=e.conditions.page_criteria,r=window.location.href,i=window.location.pathname;return n.url_pattern?new RegExp(n.url_pattern).test(r):!n.path_pattern||new RegExp(n.path_pattern).test(i)}},{key:"matchesUrlCriteria",value:function(e){var t;if(null===(t=e.conditions)||void 0===t||!t.url_pattern)return!0;var n=e.conditions.url_pattern,r=e.conditions.url_match_type||"contains",i=window.location.href;switch(r){case"exact":return i===n;case"contains":return i.includes(n);case"startsWith":return i.startsWith(n);case"endsWith":return i.endsWith(n);case"regex":try{return new RegExp(n).test(i)}catch(e){return console.warn("Crobot Tag: Invalid regex pattern: ".concat(n)),!1}default:return console.warn("Crobot Tag: Unknown URL match type: ".concat(r)),!1}}},{key:"removeGoals",value:function(e){var t=this,n=this.goals.get(e);n&&(n.forEach(function(n){var r="".concat(e,"_").concat(n.id),i=t.goalListeners.get(r);i&&(i(),t.goalListeners.delete(r)),t.activeGoals.delete(r)}),this.goals.delete(e),this.config.debug&&console.log("Crobot Tag: Removed goals for experiment ".concat(e)))}},{key:"getSessionId",value:function(){if(this.sessionId)return this.sessionId;var e=localStorage.getItem("crobot_session_id"),t=localStorage.getItem("crobot_session_timestamp"),n=this.config.tracking.sessionTimeout||18e5;if(e&&t&&Date.now()-parseInt(t)<n)return e;var r=p();try{var i=Date.now().toString();localStorage.setItem("crobot_session_id",r),localStorage.setItem("crobot_session_timestamp",i),this.config.debug&&console.log("Crobot Tag: Generated new session ID",r)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not store session ID in localStorage",e)}return r}},{key:"updateSessionActivity",value:function(){try{var e=Date.now().toString();localStorage.setItem("crobot_session_timestamp",e)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not update session activity",e)}}},{key:"destroy",value:function(){this.goalListeners.forEach(function(e){return e()}),this.goalListeners.clear(),this.activeGoals.clear(),this.goals.clear(),this.completedGoals.clear()}}]);var e}(),A=function(){return o(function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i(this,e),this.config=t,this.dataSender=n,this.sessionId=r,this.executor=new E(t),this.targeting=new C(t),this.goalTracker=new I(t,n,r),this.experiments=new Map,this.userVariants=new Map,this.userId=this.getOrCreateUserId(),this.isLoaded=!1},[{key:"loadExperiments",value:(n=r(u().m(function e(){var t,n;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.config.experiments.enabled&&this.config.experiments.autoLoad){e.n=1;break}return e.a(2);case 1:return e.p=1,this.executeCachedExperiments(),e.n=2,this.fetchExperiments();case 2:t=e.v,this.processExperiments(t),this.isLoaded=!0,this.config.debug&&console.log("Crobot Tag: Experiments loaded",this.experiments.size),e.n=4;break;case 3:e.p=3,n=e.v,console.error("Crobot Tag: Failed to load experiments",n);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return n.apply(this,arguments)})},{key:"executeCachedExperiments",value:function(){var e=this;Object.keys(localStorage).filter(function(e){return e.startsWith("crobot_variant_")}).forEach(function(t){try{var n=localStorage.getItem(t);if(n){var r=JSON.parse(n);r.expiresAt&&new Date(r.expiresAt)>new Date&&r.code&&(console.log("Crobot Tag: Executing cached experiment immediately",{experiment:r.experimentName,variant:r.variantName}),e.executor.execute(r.code))}}catch(e){console.warn("Crobot Tag: Failed to execute cached experiment",e)}})}},{key:"fetchExperiments",value:(t=r(u().m(function e(){var t,n;return u().w(function(e){for(;;)switch(e.n){case 0:return t=this.buildExperimentsEndpoint(),console.log("🔍 Fetching experiments from:",t),console.log("🔑 Using API key:",this.config.apiKey?"".concat(this.config.apiKey.substring(0,8),"..."):"MISSING"),e.n=1,fetch(t,{method:"GET",headers:{"X-API-Key":this.config.apiKey,"User-Agent":"CrobotTag/1.0.0"}});case 1:if((n=e.v).ok){e.n=2;break}throw new Error("Failed to fetch experiments: ".concat(n.status));case 2:return e.a(2,n.json())}},e,this)})),function(){return t.apply(this,arguments)})},{key:"buildExperimentsEndpoint",value:function(){var e=this.config.endpoint.replace(/\/$/,"");return"".concat(e,"/experiments")}},{key:"processExperiments",value:function(e){var t=this;Array.isArray(e)&&e.forEach(function(e){t.isExperimentValid(e)&&(t.experiments.set(e.id,e),t.assignUserToExperiment(e),e.goals&&Array.isArray(e.goals)&&t.goalTracker.registerGoals(e.id,e.goals))})}},{key:"isExperimentValid",value:function(e){return e.id&&"live"===e.status&&e.variants&&Array.isArray(e.variants)&&e.variants.length>0&&(!e.goals||Array.isArray(e.goals))}},{key:"assignUserToExperiment",value:function(e){if(!this.userVariants.has(e.id)){var t=this.getCachedVariantAssignment(e.id);if(t){console.log("Crobot Tag: Using cached variant assignment",{experiment:e.name,variant:t.variantName});var n=e.variants.find(function(e){return e.id===t.variantId});if(n)return this.userVariants.set(e.id,n),void this.executeExperiment(e,n);this.clearCachedVariantAssignment(e.id)}if(this.targeting.isUserEligible(e.targeting)){var r=this.selectVariant(e);this.userVariants.set(e.id,r),this.setCachedVariantAssignment(e.id,r,e),this.trackExperimentAssignment(e,r),this.executeExperiment(e,r)}}}},{key:"selectVariant",value:function(e){var t=this.hashString("".concat(this.userId,":").concat(e.id))%e.variants.length;return e.variants[t]}},{key:"hashString",value:function(e){for(var t=0,n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}},{key:"executeExperiment",value:function(e,t){if(t.code)try{this.executor.execute(t.code,{experimentId:e.id,variantId:t.id,userId:this.userId,experiment:e,variant:t}),this.config.debug&&console.log("Crobot Tag: Experiment executed",e.id,t.id)}catch(n){console.error("Crobot Tag: Experiment execution failed",n),this.trackExperimentError(e,t,n)}}},{key:"trackExperimentAssignment",value:(e=r(u().m(function e(t,n){var r,i,o,a;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(S(this.config,"analytics")){e.n=1;break}return e.a(2);case 1:if(r=t.id.startsWith("demo-")){e.n=7;break}return e.p=2,e.n=3,fetch("".concat(this.config.endpoint,"/experiments/assign"),{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey,"User-Agent":"CrobotTag/1.0.0"},body:JSON.stringify({experiment_id:t.id,user_id:this.userId,variant_id:n.id})});case 3:if((i=e.v).ok){e.n=4;break}throw new Error("Failed to track assignment: ".concat(i.status));case 4:e.n=6;break;case 5:e.p=5,a=e.v,console.error("Crobot Tag: Failed to track experiment assignment",a);case 6:e.n=8;break;case 7:console.log("Crobot Tag: Demo experiment assignment (not tracked to backend):",{experiment_id:t.id,variant_id:n.id});case 8:o={event:"experiment_assigned",properties:{experiment_id:t.id,experiment_name:t.name,variant_id:n.id,variant_name:n.name,assignment_time:k(),is_demo:r},timestamp:k(),session_id:this.getSessionId(),user_id:this.userId},this.dataSender.send(o);case 9:return e.a(2)}},e,this,[[2,5]])})),function(t,n){return e.apply(this,arguments)})},{key:"trackExperimentError",value:function(e,t,n){if(S(this.config,"analytics")){var r={event:"experiment_error",properties:{experiment_id:e.id,variant_id:t.id,error_message:n.message,error_stack:n.stack},timestamp:k(),session_id:this.getSessionId(),user_id:this.userId};this.dataSender.send(r)}}},{key:"getExperiment",value:function(e){return this.experiments.get(e)}},{key:"isInExperiment",value:function(e){return this.userVariants.has(e)}},{key:"getVariant",value:function(e){return this.userVariants.get(e)}},{key:"getAllExperiments",value:function(){return Array.from(this.experiments.values())}},{key:"getAllVariants",value:function(){return Array.from(this.userVariants.entries()).map(function(e){var t=h(e,2);return{experimentId:t[0],variant:t[1]}})}},{key:"getOrCreateUserId",value:function(){var e=localStorage.getItem("crobot_user_id");if(e)return e;var t=y();return localStorage.setItem("crobot_user_id",t),t}},{key:"getSessionId",value:function(){if(this.sessionId)return this.sessionId;var e=localStorage.getItem("crobot_session_id"),t=localStorage.getItem("crobot_session_timestamp"),n=this.config.tracking.sessionTimeout||18e5;if(e&&t&&Date.now()-parseInt(t)<n)return e;var r=p();try{var i=Date.now().toString();localStorage.setItem("crobot_session_id",r),localStorage.setItem("crobot_session_timestamp",i),this.config.debug&&console.log("Crobot Tag: Generated new session ID",r)}catch(e){this.config.debug&&console.warn("Crobot Tag: Could not store session ID in localStorage",e)}return r}},{key:"getCachedVariantAssignment",value:function(e){try{var t=localStorage.getItem("crobot_variant_".concat(e));if(t){var n=JSON.parse(t);if(n.expiresAt&&new Date(n.expiresAt)>new Date)return n;localStorage.removeItem("crobot_variant_".concat(e))}}catch(e){console.warn("Crobot Tag: Failed to parse cached variant assignment",e)}return null}},{key:"setCachedVariantAssignment",value:function(e,t,n){try{var r={experimentId:e,variantId:t.id,variantName:t.name,experimentName:n.name,assignedAt:(new Date).toISOString(),expiresAt:new Date(n.end_date).toISOString(),code:t.code};localStorage.setItem("crobot_variant_".concat(e),JSON.stringify(r))}catch(e){console.warn("Crobot Tag: Failed to cache variant assignment",e)}}},{key:"clearCachedVariantAssignment",value:function(e){localStorage.removeItem("crobot_variant_".concat(e))}},{key:"clearAllCachedExperiments",value:function(){Object.keys(localStorage).filter(function(e){return e.startsWith("crobot_variant_")}).forEach(function(e){return localStorage.removeItem(e)}),console.log("Crobot Tag: Cleared all cached experiment assignments")}},{key:"goalTrackerInstance",get:function(){return this.goalTracker}},{key:"removeExperiment",value:function(e){this.experiments.has(e)&&(this.goalTracker.removeGoals(e),this.experiments.delete(e),this.userVariants.delete(e),this.config.debug&&console.log("Crobot Tag: Removed experiment ".concat(e)))}},{key:"destroy",value:function(){this.executor.destroy(),this.goalTracker.destroy(),this.experiments.clear(),this.userVariants.clear()}}]);var e,t,n}(),O=function(){return o(function e(t){i(this,e),this.config=t,this.batch=[],this.maxSize=t.batchSize||10,this.maxAge=t.maxAge||3e4,this.lastFlush=Date.now()},[{key:"add",value:function(e){this.batch.push(c(c({},e),{},{addedAt:Date.now()}))}},{key:"isFull",value:function(){return this.batch.length>=this.maxSize}},{key:"isOld",value:function(){return Date.now()-this.lastFlush>this.maxAge}},{key:"shouldFlush",value:function(){return this.isFull()||this.isOld()}},{key:"getBatch",value:function(){var e=d(this.batch);return this.clear(),e}},{key:"clear",value:function(){this.batch=[],this.lastFlush=Date.now()}},{key:"size",value:function(){return this.batch.length}},{key:"isEmpty",value:function(){return 0===this.batch.length}},{key:"getOldestEvent",value:function(){return 0===this.batch.length?null:this.batch.reduce(function(e,t){return t.addedAt<e.addedAt?t:e})}},{key:"getNewestEvent",value:function(){return 0===this.batch.length?null:this.batch.reduce(function(e,t){return t.addedAt>e.addedAt?t:e})}},{key:"getEventsByType",value:function(e){return this.batch.filter(function(t){return t.event===e})}},{key:"getEventsSince",value:function(e){return this.batch.filter(function(t){return t.timestamp>=e})}},{key:"removeOlderThan",value:function(e){this.batch=this.batch.filter(function(t){return t.timestamp>=e})}}])}(),L=function(){return o(function e(t){i(this,e),this.config=t,this.maxAttempts=t.retryAttempts||3,this.baseDelay=t.retryDelay||1e3,this.maxDelay=t.maxRetryDelay||3e4,this.retryQueue=new Map},[{key:"scheduleRetry",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(n>this.maxAttempts)console.error("Crobot Tag: Max retry attempts reached, giving up");else{var r=this.calculateDelay(n),i=this.generateRetryId(),o=setTimeout(function(){t.retryQueue.delete(i),e()},r);this.retryQueue.set(i,{timeoutId:o,attempt:n,scheduledAt:Date.now()}),this.config.debug&&console.log("Crobot Tag: Retry scheduled (attempt ".concat(n,"/").concat(this.maxAttempts,") in ").concat(r,"ms"))}}},{key:"calculateDelay",value:function(e){var t=this.baseDelay*Math.pow(2,e-1),n=.1*Math.random()*t;return Math.min(t+n,this.maxDelay)}},{key:"generateRetryId",value:function(){return"retry_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}},{key:"cancelAllRetries",value:function(){this.retryQueue.forEach(function(e){var t=e.timeoutId;clearTimeout(t)}),this.retryQueue.clear()}},{key:"getRetryStats",value:function(){return{activeRetries:this.retryQueue.size,maxAttempts:this.maxAttempts,baseDelay:this.baseDelay}}},{key:"isCircuitOpen",value:function(){return!1}},{key:"recordSuccess",value:function(){}},{key:"recordFailure",value:function(){}}])}(),D=function(){return o(function e(t){i(this,e),this.config=t,this.batcher=new O(t.transmission),this.retryManager=new L(t.transmission),this.endpoint=this.buildEndpoint(),this.isOnline=navigator.onLine,this.offlineQueue=[],this.setupConnectivityDetection(),this.setupPeriodicFlush()},[{key:"send",value:function(e){S(this.config,"analytics")?(this.batcher.add(e),this.batcher.isFull()&&this.flush()):this.config.debug&&console.log("Crobot Tag: Data collection not allowed due to privacy settings")}},{key:"flush",value:function(){var e=this.batcher.getBatch();if(null!=(t=e)&&("string"==typeof t?0!==t.trim().length:Array.isArray(t)?0!==t.length:"object"!==g(t)||0!==Object.keys(t).length)){var t,n;if(!this.isOnline)return(n=this.offlineQueue).push.apply(n,d(e)),void(this.config.debug&&console.log("Crobot Tag: Stored events for offline transmission",e.length));this.sendBatch(e)}}},{key:"sendBatch",value:(n=r(u().m(function e(t){var n,r,i,o,a,s,c=this;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(i={events:t,timestamp:Date.now(),session_id:null===(n=t[0])||void 0===n?void 0:n.session_id,user_id:null===(r=t[0])||void 0===r?void 0:r.user_id},!((o=JSON.stringify(i).length)>this.config.performance.maxPayloadSize)){e.n=1;break}return this.config.debug&&console.warn("Crobot Tag: Payload too large (".concat(w(o),"), splitting batch")),this.splitAndSendBatch(t),e.a(2);case 1:return e.p=1,e.n=2,this.makeRequest(i);case 2:if(!(a=e.v).ok){e.n=3;break}this.config.debug&&console.log("Crobot Tag: Batch sent successfully",t.length),this.batcher.clear(),e.n=4;break;case 3:throw new Error("HTTP ".concat(a.status,": ").concat(a.statusText));case 4:e.n=6;break;case 5:e.p=5,s=e.v,this.config.debug&&console.error("Crobot Tag: Batch send failed",s),this.retryManager.scheduleRetry(function(){return c.sendBatch(t)});case 6:return e.a(2)}},e,this,[[1,5]])})),function(e){return n.apply(this,arguments)})},{key:"splitAndSendBatch",value:function(e){var t=Math.floor(e.length/2),n=e.slice(0,t),r=e.slice(t);this.sendBatch(n),this.sendBatch(r)}},{key:"makeRequest",value:(t=r(u().m(function e(t){var n,r,i=arguments;return u().w(function(e){for(;;)switch(e.n){case 0:if(n=(i.length>1&&void 0!==i[1]?i[1]:null)||this.endpoint,r={method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey,"User-Agent":"CrobotTag/1.0.0"},body:JSON.stringify(t)},!this.supportsCompression()){e.n=2;break}return r.headers["Content-Encoding"]="gzip",e.n=1,this.compressData(t);case 1:r.body=e.v;case 2:return e.a(2,fetch(n,r))}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"buildEndpoint",value:function(){var e=this.config.endpoint.replace(/\/$/,"");return"".concat(e,"/events")}},{key:"buildExperimentsEndpoint",value:function(){var e=this.config.endpoint.replace(/\/$/,"");return"".concat(e,"/experiments")}},{key:"setupConnectivityDetection",value:function(){var e=this;window.addEventListener("online",function(){e.isOnline=!0,e.processOfflineQueue()}),window.addEventListener("offline",function(){e.isOnline=!1})}},{key:"setupPeriodicFlush",value:function(){var e=this;setInterval(function(){e.flush()},this.config.transmission.flushInterval)}},{key:"processOfflineQueue",value:function(){if(0!==this.offlineQueue.length){this.config.debug&&console.log("Crobot Tag: Processing offline queue",this.offlineQueue.length);var e=d(this.offlineQueue);this.offlineQueue=[];for(var t=this.config.transmission.batchSize,n=0;n<e.length;n+=t){var r=e.slice(n,n+t);this.sendBatch(r)}}}},{key:"supportsCompression",value:function(){return"undefined"!=typeof CompressionStream}},{key:"compressData",value:(e=r(u().m(function e(t){var n,r,i,o,a,s,c,l,h;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.supportsCompression()){e.n=1;break}return e.a(2,JSON.stringify(t));case 1:e.p=1,n=new CompressionStream("gzip"),r=n.writable.getWriter(),i=n.readable.getReader(),r.write((new TextEncoder).encode(JSON.stringify(t))),r.close(),o=[],a=!1;case 2:if(a){e.n=4;break}return e.n=3,i.read();case 3:s=e.v,c=s.value,l=s.done,a=l,c&&o.push(c),e.n=2;break;case 4:return e.a(2,new Uint8Array(o.reduce(function(e,t){return[].concat(d(e),d(t))},[])));case 5:return e.p=5,h=e.v,this.config.debug&&console.warn("Crobot Tag: Compression failed, sending uncompressed",h),e.a(2,JSON.stringify(t))}},e,this,[[1,5]])})),function(t){return e.apply(this,arguments)})},{key:"getQueueSize",value:function(){return this.batcher.size()+this.offlineQueue.length}},{key:"clearQueue",value:function(){this.batcher.clear(),this.offlineQueue=[]}}]);var e,t,n}(),P=function(){function e(t){i(this,e),this.config=t,this.prefix="crobot_",this.storage=this.getStorage()}return o(e,[{key:"getStorage",value:function(){if(void 0!==e&&localStorage)try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),localStorage}catch(e){}if(void 0!==e&&sessionStorage)try{return sessionStorage.setItem("test","test"),sessionStorage.removeItem("test"),sessionStorage}catch(e){}return new G}},{key:"set",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r={value:t,timestamp:Date.now(),ttl:n};try{this.storage.setItem(this.prefix+e,JSON.stringify(r))}catch(e){this.config.debug&&console.warn("Crobot Tag: Storage set failed",e)}}},{key:"get",value:function(e){try{var t=this.storage.getItem(this.prefix+e);if(!t)return null;var n=JSON.parse(t);return n.ttl&&Date.now()-n.timestamp>n.ttl?(this.remove(e),null):n.value}catch(e){return this.config.debug&&console.warn("Crobot Tag: Storage get failed",e),null}}},{key:"remove",value:function(e){try{this.storage.removeItem(this.prefix+e)}catch(e){this.config.debug&&console.warn("Crobot Tag: Storage remove failed",e)}}},{key:"clear",value:function(){var e=this;try{Object.keys(this.storage).forEach(function(t){t.startsWith(e.prefix)&&e.storage.removeItem(t)})}catch(e){this.config.debug&&console.warn("Crobot Tag: Storage clear failed",e)}}},{key:"getAll",value:function(){var e=this,t={};try{Object.keys(this.storage).forEach(function(n){if(n.startsWith(e.prefix)){var r=e.get(n.substring(e.prefix.length));null!==r&&(t[n.substring(e.prefix.length)]=r)}})}catch(e){this.config.debug&&console.warn("Crobot Tag: Storage getAll failed",e)}return t}}])}(),G=function(){return o(function e(){i(this,e),this.data={}},[{key:"setItem",value:function(e,t){this.data[e]=t}},{key:"getItem",value:function(e){return this.data[e]||null}},{key:"removeItem",value:function(e){delete this.data[e]}}])}(),j={apiKey:null,endpoint:"https://api.crobot.com",tracking:{pageViews:!0,clicks:!0,scroll:!0,performance:!0,timeOnPage:!0,formSubmissions:!0,sessionTimeout:18e5},experiments:{enabled:!0,autoLoad:!0,cacheTime:3e5,executionTimeout:5e3},transmission:{batchSize:10,flushInterval:1e4,retryAttempts:3,retryDelay:1e3,offlineStorage:!0},privacy:{respectDoNotTrack:!0,anonymizeIp:!1,dataRetention:365,consentRequired:!1},performance:{lazyLoad:!1,deferExecution:!1,maxPayloadSize:1048576},debug:!1,custom:{}};function F(){var e=N(j,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return e.apiKey||console.warn("Crobot Tag: No API key provided. Some features may not work."),e.endpoint&&!function(e){try{return new URL(e),!0}catch(e){return!1}}(e.endpoint)&&(console.error("Crobot Tag: Invalid endpoint URL"),e.endpoint=j.endpoint),"object"!==g(e.tracking)&&(e.tracking=j.tracking),"object"!==g(e.experiments)&&(e.experiments=j.experiments),e.debug&&console.log("Crobot Tag: Debug mode enabled"),e}function N(e,t){var n=c({},e);for(var r in t)t.hasOwnProperty(r)&&("object"!==g(t[r])||null===t[r]||Array.isArray(t[r])?n[r]=t[r]:n[r]=N(e[r]||{},t[r]));return n}var M=function(){return o(function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.config=F(n),this._tracker=null,this._experimentManager=null,this._dataSender=null,this.storage=null,this.initialized=!1,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){return t.init()}):this.init()},[{key:"init",value:function(){if(!this.initialized)try{this.storage=new P(this.config),this._dataSender=new D(this.config),this._tracker=new x(this.config,this._dataSender),this._experimentManager=new A(this.config,this._dataSender,this._tracker.sessionId),this._tracker.start(),this._experimentManager.loadExperiments(),this.initialized=!0,this.emit("ready")}catch(e){console.error("Crobot Tag initialization failed:",e),this.emit("error",e)}}},{key:"track",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.initialized)return this._tracker.track(e,t);console.warn("Crobot Tag not initialized yet")}},{key:"identify",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.initialized)return this._tracker.identify(e,t);console.warn("Crobot Tag not initialized yet")}},{key:"page",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.initialized)return this._tracker.page(e,t);console.warn("Crobot Tag not initialized yet")}},{key:"getExperiment",value:function(e){return this.initialized?this._experimentManager.getExperiment(e):(console.warn("Crobot Tag not initialized yet"),null)}},{key:"getAllExperiments",value:function(){return this.initialized?this._experimentManager.getAllExperiments():(console.warn("Crobot Tag not initialized yet"),[])}},{key:"getAllVariants",value:function(){return this.initialized?this._experimentManager.getAllVariants():(console.warn("Crobot Tag not initialized yet"),[])}},{key:"isInExperiment",value:function(e){return this.initialized?this._experimentManager.isInExperiment(e):(console.warn("Crobot Tag not initialized yet"),!1)}},{key:"clearExperimentCache",value:function(){this.initialized?this._experimentManager.clearAllCachedExperiments():console.warn("Crobot Tag not initialized yet")}},{key:"getGoalTracker",value:function(){return this.initialized?this._experimentManager.goalTrackerInstance:(console.warn("Crobot Tag not initialized yet"),null)}},{key:"triggerGoal",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(this.initialized){if(this._experimentManager.goalTrackerInstance){var i={event:"goal_completed",experiment_id:e,goal_id:t,goal_name:"Custom Goal: ".concat(t),goal_type:"custom_event",value:n,properties:r,timestamp:Date.now(),session_id:this._tracker.sessionId,user_id:this._tracker.userId,page_url:window.location.href,page_title:document.title};this._dataSender&&this._dataSender.send(i),this.config.debug&&console.log("Crobot Tag: Custom goal triggered",i)}}else console.warn("Crobot Tag not initialized yet")}},{key:"getConfig",value:function(){return c({},this.config)}},{key:"experimentManager",get:function(){return this._experimentManager}},{key:"tracker",get:function(){return this._tracker}},{key:"dataSender",get:function(){return this._dataSender}},{key:"on",value:function(e,t){this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(t)}},{key:"off",value:function(e,t){this._events&&this._events[e]&&(this._events[e]=this._events[e].filter(function(e){return e!==t}))}},{key:"emit",value:function(e,t){this._events&&this._events[e]&&this._events[e].forEach(function(e){try{e(t)}catch(e){console.error("Error in event callback:",e)}})}},{key:"destroy",value:function(){this._tracker&&this._tracker.stop(),this._experimentManager&&this._experimentManager.destroy(),this._dataSender&&this._dataSender.flush(),this.initialized=!1}}])}();"undefined"!=typeof window&&window.CrobotConfig&&(window.crobot=new M(window.CrobotConfig)),"undefined"!=typeof window&&(window.CrobotTag=M),e.CrobotTag=M,e.default=M,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=crobot-tag.min.js.map
